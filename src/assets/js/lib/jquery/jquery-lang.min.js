(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","Cookies"],factory)}else if(typeof exports==="object"){module.exports=factory()}else{var _OldLang=window.Lang;var api=window.Lang=factory(jQuery,typeof Cookies!=="undefined"?Cookies:undefined);api.noConflict=function(){window.Lang=_OldLang;return api}}})(function($,Cookies){var Lang=function(){this._fireEvents=true;this._dynamic={}};Lang.prototype.init=function(options){var self=this,cookieLang,defaultLang,currentLang,allowCookieOverride;options=options||{};options.cookie=options.cookie||{};defaultLang=options.defaultLang;currentLang=options.currentLang;allowCookieOverride=options.allowCookieOverride;this.cookieName=options.cookie.name||"langCookie";this.cookieExpiry=options.cookie.expiry||365;this.cookiePath=options.cookie.path||"/";this._mutationCopies={append:$.fn.append,appendTo:$.fn.appendTo,prepend:$.fn.prepend,before:$.fn.before,after:$.fn.after,html:$.fn.html};$.fn.append=function(){return self._mutation(this,"append",arguments)};$.fn.appendTo=function(){return self._mutation(this,"appendTo",arguments)};$.fn.prepend=function(){return self._mutation(this,"prepend",arguments)};$.fn.before=function(){return self._mutation(this,"before",arguments)};$.fn.after=function(){return self._mutation(this,"after",arguments)};$.fn.html=function(){return self._mutation(this,"html",arguments)};this.defaultLang=defaultLang||"en";this.currentLang=defaultLang||"en";if((allowCookieOverride||!currentLang)&&typeof Cookies!=="undefined"){cookieLang=Cookies.get(this.cookieName);if(cookieLang){currentLang=cookieLang}}$(function(){self._start();self.change(currentLang)})};Lang.prototype.pack={};Lang.prototype.attrList=["title","alt","placeholder","href"];Lang.prototype.dynamic=function(lang,path){if(lang!==undefined&&path!==undefined){this._dynamic[lang]=path}};Lang.prototype.loadPack=function(lang,callback){var self=this;if(lang&&self._dynamic[lang]){$.ajax({dataType:"json",url:self._dynamic[lang],success:function(data){self.pack[lang]=data;if(self.pack[lang].regex){var packRegex=self.pack[lang].regex,regex,i;for(i=0;i<packRegex.length;i++){regex=packRegex[i];if(regex.length===2){regex[0]=new RegExp(regex[0])}else if(regex.length===3){regex[0]=new RegExp(regex[0],regex[1]);regex.splice(1,1)}}}if(callback){callback(false,lang,self._dynamic[lang])}},error:function(){if(callback){callback(true,lang,self._dynamic[lang])}throw"Error loading language pack"+self._dynamic[lang]}})}else{throw"Cannot load language pack, no file path specified!"}};Lang.prototype._start=function(selector){var arr=selector!==undefined?$(selector).find("[lang]"):$(":not(html)[lang]"),arrCount=arr.length,elem;while(arrCount--){elem=$(arr[arrCount]);this._processElement(elem)}};Lang.prototype._processElement=function(elem){if(elem.attr("lang")===this.defaultLang){this._storeAttribs(elem);this._storeContent(elem)}};Lang.prototype._storeAttribs=function(elem){var attrIndex,attr,attrObj;for(attrIndex=0;attrIndex<this.attrList.length;attrIndex++){attr=this.attrList[attrIndex];if(elem.attr(attr)){attrObj=elem.data("langAttr")||{};attrObj[attr]=elem.attr(attr);elem.data("langAttr",attrObj)}}};Lang.prototype._storeContent=function(elem){if(elem.is("input")){switch(elem.attr("type")){case"button":case"submit":case"hidden":case"reset":elem.data("langVal",elem.val());break}}else if(elem.is("img")){elem.data("langSrc",elem.attr("src"))}else{var nodes=this._getTextNodes(elem);if(nodes){elem.data("langText",nodes)}}};Lang.prototype._getTextNodes=function(elem){var nodes=elem.contents(),nodeObjArray=[];$.each(nodes,function(index,node){if(node.nodeType!==3){return}nodeObjArray.push({node:node,langDefaultText:node.data})});if(nodeObjArray.length===1){nodeObjArray[0].langToken=elem.data("langToken")}return nodeObjArray};Lang.prototype._setTextNodes=function(elem,nodes,lang,data){var regexCheckForHtmlTag=/<[^>]+>/g,index,textNode,translation,defaultContent,token;for(index=0;index<nodes.length;index++){textNode=nodes[index];token=textNode.langToken;defaultContent=$.trim(textNode.langDefaultText);if(token){translation=this.translate(token,lang,data)}else if(defaultContent){translation=this.translate(defaultContent,lang,data)}if(regexCheckForHtmlTag.test(translation)){elem[0].innerHTML=translation}else if(translation){try{textNode.node.data=textNode.node.data.split($.trim(textNode.node.data)).join(translation)}catch(e){}}else{if(console&&console.log){console.log('Translation for "'+defaultContent+'" not found!')}}}};Lang.prototype._translateAttribs=function(elem,lang,data){var attr,attrObj=elem.data("langAttr")||{},translation;for(attr in attrObj){if(attrObj.hasOwnProperty(attr)){if(elem.attr(attr)){if(lang!==this.defaultLang){translation=this.translate(attrObj[attr],lang,data);if(translation){elem.attr(attr,translation)}}else{elem.attr(attr,attrObj[attr])}}}}};Lang.prototype._translateContent=function(elem,lang,data){var langIsDefault=lang===this.defaultLang,translation,originalContent,token;if(elem.is("input")){switch(elem.attr("type")){case"button":case"submit":case"hidden":case"reset":originalContent=elem.data("langVal");token=elem.data("langToken")||originalContent;translation=this.translate(token,lang,data);elem.val(translation);break}}else if(elem.is("img")){originalContent=elem.data("langSrc");token=elem.data("langToken")||originalContent;translation=this.translate(token,lang,data);elem.attr("src",translation)}else{originalContent=elem.data("langText");token=elem.data("langToken");if(token){translation=this.translate(token,lang,data);if(translation){elem[0].innerHTML=translation}}else if(originalContent){this._setTextNodes(elem,originalContent,lang,data)}}};Lang.prototype.getLangDataFromElement=function(elem){return elem.data("langDefaultData")};Lang.prototype.change=function(lang,selector,callback){var self=this;var langIsDefault=lang===this.defaultLang;var packIsLoaded=this.pack[lang];var packIsDynamic=this._dynamic[lang];if(!langIsDefault&&!packIsLoaded&&!packIsDynamic){if(callback){callback("No language pack defined for: "+lang,lang,selector)}throw'Attempt to change language to "'+lang+'" but no language pack for that language is loaded!'}if(!packIsLoaded&&packIsDynamic){this.loadPack(lang,function(err,loadingLang,fromUrl){if(err){if(callback){callback("Language pack could not load from: "+fromUrl,lang,selector)}return}self.change.call(self,lang,selector,callback)});return}var fireAfterUpdate=false,currLang=this.currentLang;if(this.currentLang!==lang){this.beforeUpdate(currLang,lang);fireAfterUpdate=true}this.currentLang=lang;var arr=selector!==undefined?$(selector).find("[lang]"):$(":not(html)[lang]"),arrCount=arr.length,elem;while(arrCount--){elem=$(arr[arrCount]);if(!elem.data("langScanned")||elem.attr("lang")!==lang){elem.data("langScanned",true);this._translateElement(elem,lang,this.getLangDataFromElement(elem))}}if(fireAfterUpdate){this.afterUpdate(currLang,lang)}if(typeof Cookies!=="undefined"){Cookies.set(self.cookieName,lang,{expires:self.cookieExpiry,path:self.cookiePath})}if(callback){callback(false,lang,selector)}};Lang.prototype._translateElement=function(elem,lang,data){this._translateAttribs(elem,lang,data);var contentInAttribute=elem.attr("data-lang-content");if(contentInAttribute!=="false"){this._translateContent(elem,lang,data)}elem.attr("lang",lang)};Lang.prototype.getDataAtPath=function(obj,path,defaultVal){var self=this,internalPath=path,objPart;if(path instanceof Array){var returnData=[];for(var i=0;i<path.length;i++){var individualPath=path[i];returnData.push(self.getDataAtPath(obj,individualPath))}return returnData}if(obj===undefined||obj===null){return defaultVal}if(!internalPath){return obj}if(typeof internalPath!=="string"){throw new Error("Path argument must be a string")}if(internalPath.indexOf(".")===-1){return obj[internalPath]!==undefined?obj[internalPath]:defaultVal}if(typeof obj!=="object"){return defaultVal!==undefined?defaultVal:undefined}const pathParts=internalPath.split(".");objPart=obj;for(var i=0;i<pathParts.length;i++){var pathPart=pathParts[i];objPart=objPart[pathPart];if(!objPart||typeof objPart!=="object"){if(i!==pathParts.length-1){objPart=undefined}break}}return objPart!==undefined?objPart:defaultVal};Lang.prototype._parseTemplate=function(str,data){if(!str||!data)return str;var finalTranslation=str;if(str&&str.indexOf("${")){var regexp=/\${([\s\S]+?)}/g;var matches;while(matches=regexp.exec(str)){var matchString=matches[0];var dataPath=matches[1];finalTranslation=finalTranslation.replace(matchString,this.getDataAtPath(data,dataPath))}}return finalTranslation};Lang.prototype.translate=function(text,lang,data){var translation="",langIsDefault=lang===this.defaultLang;lang=lang||this.currentLang;if(!this.pack[lang]){return text}translation=this._parseTemplate(this.pack[lang].token[text],{data:data});if(!translation){translation=this._regexMatch(text,lang)}if(!translation&&!langIsDefault){if(console&&console.log){console.log('Translation for "'+text+'" not found in language pack: '+lang)}}return translation||text};Lang.prototype._regexMatch=function(text,lang){var arr,arrCount,arrIndex,item,regex,expressionResult;arr=this.pack[lang].regex;if(arr){arrCount=arr.length;for(arrIndex=0;arrIndex<arrCount;arrIndex++){item=arr[arrIndex];regex=item[0];expressionResult=regex.exec(text);if(expressionResult&&expressionResult[0]){return text.split(expressionResult[0]).join(item[1])}}}return""};Lang.prototype.beforeUpdate=function(currentLang,newLang){if(this._fireEvents){$(this).triggerHandler("beforeUpdate",[currentLang,newLang,this.pack[currentLang],this.pack[newLang]])}};Lang.prototype.afterUpdate=function(currentLang,newLang){if(this._fireEvents){$(this).triggerHandler("afterUpdate",[currentLang,newLang,this.pack[currentLang],this.pack[newLang]])}};Lang.prototype.refresh=function(){this._fireEvents=false;this.change(this.currentLang);this._fireEvents=true};Lang.prototype._mutation=function(context,method,args){var result=this._mutationCopies[method].apply(context,args),currLang=this.currentLang,rootElem=$(context),data;if(rootElem.attr("lang")){this._fireEvents=false;this._translateElement(rootElem,this.defaultLang,this.getLangDataFromElement(rootElem));this.change(this.defaultLang,rootElem);this.currentLang=currLang;this._processElement(rootElem);this._translateElement(rootElem,this.currentLang,this.getLangDataFromElement(rootElem))}this._start(rootElem);this.change(this.currentLang,rootElem);this._fireEvents=true;return result};return Lang});